<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>17.4 Thunk函数</title>
</head>
<body>
    <script>
    //Thunk函数早在上个世纪60年代就诞生.
    //那时,编程语言刚刚起步,计算机科学家还在研究如何编写编译器比较好.
    //一个争论的焦点是'求值策略',即函数的参数到底应该在何时求值
    var x = 1;
    function f(m) {
        return m * 2;
    }
    f(x + 5);

    //上面的代码先定义了函数f,然后向他传入表达式x+5
    //请问这个表达式何时求值
    //一种意见是'传值调用'(call by value),即在进入函数体之前就计算x+5的值(等于6);
    //再将这个值传入函数f.C语言就采用了这种策略

    //另一种意见是"传名调用"(call by name),即直接将表达式x+5传入函数体,只在用到他的时候求值
    //Haskell语言采用了这种策略

    //传值调用和传名调用,哪一种比较好
    //答案是各有利弊.传值调用比较简单,但是对参数求值IDE时候,实际上还没有用到这个参数,有可能造成性能损失

    function f1(a, b) {
        return b;
    }
    f1(3 * x * x - 2 * x - 1, x)

    //上面的代码中,函数f的第一个参数是一个复杂的表达式,但是函数体内根本没用到.
    //对这个参数求值实际上是不必要的.
    //因此,有一些计算机科学家倾向于'传名调用',即只在执行时求值

    //17.4.2 Thunk函数的含义
        //编译器的'传名调用'的实现往往是将参数放到一个临时函数之中,再将这个临时函数传入函数体
        //这个临时函数就称为Thunk函数
        function f(m) {
            return m * 2;
        }
        f(x + 5);
        
        //等同于
/*  
    var thunk = function (){
            return x + 5;
        }
        function f(thunk) {
            return thunk() * 2
        }
*/
        //上面的代码中,函数f的参数x+5被一个函数替换了.
        //凡是用到原参数的地方,对Thunk函数求值即可
        //这就是Thunk函数的定义,他是'传名调用'的一种实现策略,可以用来替换某个表达式.


    //17.4.3 JavaScript语言的Thunk函数
        //JavaScript语言是传值调用,它的Thunk函数含义有所不同
        //在JavaScript语言中,Thunk函数替换的不是表达式,而是多参函数
        //将其替换成一个只接受回调函数作为参数的单参数函数

        //正常版本的readFile(多参数版本)
//      fs.readFile(fileName, callback);

        //Thunk版本的readFile(单参数版本)
/*      var Thunk = function(fileName) {
            return function(callback) {
                return fs.readFile(fileName, callback)
            };
        };

        var readFileThunk = Thunk('fileName');
        readFileThunk(callback);
*/
        //上面的代码中,fs模块的readFile方法是一个多参数函数,两个参数分别为文件名和回调函数
        //经过转换器处理,它变成了一个单参数函数,只接受回调函数作为参数
        //这个但参数版本就叫做Thunk函数

        //任何函数,只要参数有回调函数,就能写成Thunk函数的形式.
        //下面是一个简单的Thunk函数转换器的例子
        
        //ES5 版本
        var Thunk = function(fn) {
            return function(){
                var args = Array.prototype.slice.call(arguments);
                return function(callback) {
                    args.push(callback);
                    return fn.apply(this, args);
                }
            }
        }

        //ES6 版本
        var Thunk = function(fn) {
            return function(...args) {
                return function(callback) {
                    return fn.call(this, ...args, callback);
                }
            }
        }

        //使用上面的转换器,生成fs.readFile的Thunk函数
/*      var readFileThunk = Thunk(fs.readFile);
        readFileThunk(fileA)(callback);
*/
        //下面是一个完整的例子'
        var m = function(a, cb) {
            cb(a);
        }
        const ft = Thunk(m);
        ft(1)(console.log); //1
    </script>
</body>
</html>